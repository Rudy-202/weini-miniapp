# 小程序管理员端功能对齐文档

## 一、背景与目标

本文档旨在记录小程序管理员端的核心功能需求和设计细节，确保开发团队对齐理解，并作为后续开发和测试的依据。

当前的主要目标是将网页端管理员后台的核心功能，特别是任务管理模块，在小程序端进行适配和实现，同时考虑小程序的使用场景和特性进行优化。

## 二二、核心原则

1.  **聚焦核心**：优先实现管理员最高频、最核心的操作，而非网页端功能的完整复制。
2.  **移动优先**：充分考虑移动端操作的便捷性、网络环境等因素。
3.  **数据一致**：确保小程序端与后端、网页端的数据同步和一致性。
4.  **清晰反馈**：对于用户的操作给予及时、明确的反馈。

## 三、核心功能模块：任务管理

### 3.1 查看任务列表

*   管理员能够在小程序端查看任务列表。
*   列表应展示任务的关键信息，例如：
    *   任务名称
    *   积分
    *   截止日期
    *   模式 (通过图标区分火焰模式、限时模式等)
    *   参与人数
    *   操作按钮
*   应支持必要的筛选和排序功能（具体待定）。
*   **操作按钮 (操作列)**:
    *   **编辑 (铅笔图标)**: 允许管理员修改任务的现有信息 (具体修改范围待后续定义)。
    *   **结算 (带勾的圆圈图标)**: 触发任务结算流程 (详见 3.5 任务结算)。
    *   **查看提交详情 (文件图标)**: 跳转到该任务的提交记录列表页面 (详见 3.2 查看任务提交)。

### 3.2 查看任务提交

*   管理员能够查看用户针对特定任务的提交内容。
*   应能区分不同用户的提交，并展示如：提交者、提交时间、提交的图片/内容、该次提交获得的积分、提交状态 (如：正常、异常)。
*   支持查看提交的文本、图片、视频等。
*   **针对单次提交的操作**:
    *   **详情**: 查看该次提交的完整内容。
    *   **标记异常**: 将该次提交标记为不合格 (详见 3.3 标记提交异常)。

### 3.3 标记提交异常

*   此操作在"查看任务提交"页面针对某一次具体的提交进行。
*   管理员能够将用户的某次任务提交标记为"异常"或"不合格"。
*   标记后，可能需要有相应的处理流程（如：不发放积分，通知用户等，具体待定）。
*   **重要规则**:
    *   此操作**不可撤销**。
    *   用户因此次被标记为异常的提交所获得的积分将被**扣除**。
    *   标记后，该提交的状态会相应更新并明确显示（例如，从"正常"变为"异常提交"）。
    *   **用户通知 (未来规划)**：理想情况下，用户应收到提交被标记为异常的通知。但鉴于当前MVP阶段用户系统简化（仅昵称+邀请码），此通知功能**暂不实现**，待后续用户注册功能完善后补充。

### 3.4 创建新任务

**页面表单字段与逻辑：**

1.  **所属站点 (必填)**：
    *   类型：下拉选择框。
    *   功能：选择该任务归属的站点。

2.  **邀请码 (自动关联/可选)**：
    *   默认行为：系统自动选择（并显示）**最新创建的邀请码**。
    *   管理员操作：管理员**可以从列表中选择其他已存在的邀请码**。
    *   重要规则：一个邀请码下如果已有焦点任务，则不允许再为该邀请码创建新的焦点任务（通过弹窗提醒）。

3.  **任务标题 (必填)**：
    *   类型：文本输入框。
    *   功能：任务的名称。

4.  **任务描述 (必填)**：
    *   类型：文本输入框（可能支持富文本或多行）。
    *   功能：详细描述任务内容和要求。

5.  **任务积分 (必填)**：
    *   类型：数字输入框。
    *   默认值：10。
    *   功能：完成该任务可获得的基础积分。

6.  **浴火模式 (开关)**：
    *   类型：开关控件。
    *   默认状态：**开启**。
    *   功能：
        *   开启时：用户可以**重复提交**该任务（并能重复获得积分，具体积分规则待定）。
        *   关闭时：用户**只能提交一次**该任务。

7.  **焦点任务 (开关)**：
    *   类型：开关控件（位于屏幕底端）。
    *   默认状态：关闭。
    *   功能：
        *   开启时：完成该任务可获得**双倍积分**。
        *   **重要规则 1 (针对邀请码)**：若当前选定的邀请码下已存在一个焦点任务，则不允许将此任务也设为焦点任务（通过弹窗提醒并阻止）。
        *   **重要规则 2 (邀请码内的时效性与唯一性)**：在一个邀请码下，任何24小时周期内，**只能存在一个激活的焦点任务**。
        *   **重要规则 3 (邀请码内焦点任务的状态锁定)**：一旦一个任务在某个邀请码下被设置为焦点任务，其作为该邀请码下的"焦点状态"在接下来的**24小时内不可更改**（即不能手动取消其作为该邀请码的焦点任务，也不能将该邀请码下的其他任务设为焦点，直到这个24小时周期结束）。

8.  **限时模式 (开关，显示为时钟图标)**：
    *   类型：开关控件。
    *   默认状态：关闭。
    *   功能：开启后，任务有时间限制，并可设置额外奖励积分。此时**需要填写任务截止日期**。

9. **任务截止日期 (条件显示与输入)**：
    *   类型：日期时间选择器。
    *   显示条件：仅当"限时模式"开启时显示和编辑。
    *   功能：设置任务的结束时间。

10. **限时奖励积分 (条件显示与输入)**：
    *   类型：数字输入框。
    *   显示条件：仅当"限时模式"开启时显示。
    *   功能：设置在限时模式下完成任务可获得的**额外奖励积分**。
    *   约束：额外奖励积分值**不能超过该任务的基础分值**（即 `任务积分` 字段的值）。

**积分计算顺序：**
`(基础任务积分 + 限时奖励积分) * 焦点任务倍数（例如2倍，如果开启）`

**创建后行为：**
*   任务创建成功后，页面应**直接跳转到管理员的任务列表页**。

## 四、任务结算与历史任务

### 4.1 任务结算

*   **触发方式**: 管理员在任务列表的操作列点击"结算"按钮。
*   **结算条件**: 
    *   所有任务的结算都**必须由管理员手动触发**。
    *   即使是已过截止日期的限时任务（即粉丝端已无法提交），系统也**不会自动结算**，仍需管理员手动操作。
    *   这样设计是为了确保管理员有充分的时间在结算前完成对所有提交的审核和必要的"标记异常"操作。
*   **未处理提交的默认行为**: 如果管理员在结算任务时，任务中尚有用户提交的内容但管理员未进行"标记异常"操作，这些未被标记的提交将**默认被视为"正常"通过**。
*   **结算后果**:
    *   任务状态变为"已结算"，并从主要的活跃任务列表移至"历史任务"界面/分类中。

### 4.2 历史任务

*   已结算的任务会在此处展示。
*   **操作限制**: 
    *   历史任务本身**不能被编辑**。
    *   历史任务中的任何用户提交记录也**不能再被标记为"异常"**。
*   (历史任务界面的具体功能和显示信息待后续定义)。

## 五、已知技术特殊点说明

### 5.1 管理员登录接口与Linter行为差异

*   **背景**：在实现管理员登录功能时（`src/api/user.ts`中的`adminLogin`函数），后端提供的 `/api/admin/login` 接口返回的是一个扁平的JSON对象 (e.g., `{token: "...", user: {...}}`)。
*   **`request`辅助函数**：项目中的 `src/api/request.ts` 内的 `request<T>` 函数，实际运行时会将API返回的直接JSON体作为 `Promise` 解析后的值。
*   **Linter误报**：开发环境中的Linter（尤其在某些辅助编码工具中）持续错误地认为 `await request<AdminLoginFlatApiResponse>(...)` 的返回类型是 `ResponseData<AdminLoginFlatApiResponse>`（即一个被 `{data: T, code, message}` 结构包装过的对象）。
*   **解决方案**：我们选择相信运行时的正确行为，并相应地处理扁平结构。代码中保留了对扁平结构的直接访问，尽管Linter可能会报错。
*   **记录位置**：此问题的详细排查和最终代码逻辑已记录在 `测试与优化结果.md` 文件的"五、Linter 与运行时行为差异记录"章节。建议查阅该文档以获取完整上下文。

*(后续可根据讨论补充其他功能模块和细节)* 